{"version":3,"sources":["../../../src/middlewares/render/userContext.js"],"names":["wechatConfig","getWechat","client","appid","secret","req","res","next","absoluteUrl","baseUrl","path","session","user","url","getAuthorizeURL","host","redirect","e","error"],"mappings":";;;;;;;;;;;;;;;;;;AAKA;;;;AACA;;;;AACA;;;;;;AAEA,IAAIA,eAAe,iBAAOC,SAAP,EAAnB;AARA;;;;AASA,IAAIC,SAAS,0BAAUF,aAAaG,KAAvB,EAA8BH,aAAaI,MAA3C,CAAb;;;0EAEe,iBAAOC,GAAP,EAAYC,GAAZ,EAAiBC,IAAjB;AAAA;AAAA;AAAA;AAAA;AAAA;AACX,4BAAI;AACA;AACIC,uCAFJ,GAEkBH,IAAII,OAAJ,GAAcJ,IAAIK,IAFpC;;AAIA;;AACA,gCAAIF,eAAe,mBAAf,IACGH,IAAII,OAAJ,IAAe,SADlB,IAEGJ,IAAII,OAAJ,IAAa,SAFpB,EAE+B;AAC3BF;AACH,6BAJD,MAKK;AACD,oCAAI,CAACF,IAAIM,OAAJ,CAAYC,IAAjB,EAAuB;AACfC,uCADe,GACTX,OAAOY,eAAP,CAA0Bd,aAAae,IAAvC,mBAA2DP,WAA3D,CADS;;AAEnBF,wCAAIU,QAAJ,CAAaH,GAAb;AACH,iCAHD,MAIK;AACDN;AACH;AACJ;AACJ,yBAnBD,CAmBE,OAAOU,CAAP,EAAU;AACR,6CAAOC,KAAP,CAAa,sBAAsB,yBAAeD,CAAf,CAAnC;AACH;;AAtBU;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,K","file":"userContext.js","sourcesContent":["\n/**\n * desc:\n */\n\nimport OAuth from 'wechat-oauth'\nimport logger from '../../utils/logger';\nimport config from '../../utils/config';\n\nlet wechatConfig = config.getWechat();\nlet client = new OAuth(wechatConfig.appid, wechatConfig.secret);\n\nexport default async (req, res, next) => {\n    try {\n        //判断路由是否是account/register\n        let absoluteUrl = req.baseUrl + req.path;\n\n        //todo:之后需要加个配置管理如下的特殊需求\n        if (absoluteUrl == \"/account/register\"\n            || req.baseUrl == \"/wechat\"\n            || req.baseUrl==\"/common\") {\n            next()\n        }\n        else {\n            if (!req.session.user) {\n                var url = client.getAuthorizeURL(`${wechatConfig.host}/wechat/auth`, absoluteUrl);\n                res.redirect(url);\n            }\n            else {\n                next();\n            }\n        }\n    } catch (e) {\n        logger.error(\"userContext error\" + JSON.stringify(e))\n    }\n}"]}