{"version":3,"sources":["../../../src/routers/render/personal.js"],"names":["router","Router","get","req","res","next","param","matchJavascript","matchStylesheet","templateData","getTemplateBasicData","memberId","session","user","member","id","requestHelper","totalInfo","wechatOpenId","wechat","memberInfo","data","balance","points","phoneNo","name","cardNo","level","memberLevel","render","error","idCardNo","startDatetime","startOf","format","endDatetime","endOf","monthRanking","monthTotal","yearRanking","yearTotal","info","rows","module","exports"],"mappings":"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","file":"personal.js","sourcesContent":["import express from 'express'\nimport logger from '../../utils/logger'\nimport routerUtil from '../../utils/router'\nimport moment from 'moment'\nlet router = express.Router()\n\nrouter.get('/list', async (req, res, next) => {\n  try {\n    let param = {\n      req: req,\n      matchJavascript: true,\n      matchStylesheet: true\n    }\n\n    let templateData = routerUtil.getTemplateBasicData(param)\n\n    let memberId = req.session.user.member.id\n\n    let totalInfo = await requestHelper.get({\n      'moduleName': 'hulk_service',\n      'controller': 'member',\n      'action': 'findTotal',\n      'data': {memberId}\n    })\n\n    let memberInfo = await requestHelper.get({\n      'moduleName': 'hulk_service',\n      'controller': 'member',\n      'action': 'find',\n      'data': {wechatOpenId:req.session.user.member.wechat.wechatOpenId}\n    })\n    req.session.user = memberInfo.data\n    Object.assign(templateData, { 'title': '个人中心' }, {\n        balance: (totalInfo.data && totalInfo.data.balance) || 0, \n        points: (totalInfo.data && totalInfo.data.points) || 0 ,\n        // nickName:req.session.user.member.wechat.nickName,\n        // headImgUrl:req.session.user.member.wechat.headImgUrl,\n        phoneNo:req.session.user.phoneNo,\n        name:req.session.user.name,\n        cardNo:req.session.user.member.cardNo,\n        level:memberInfo.data.member.memberLevel.name\n      })\n\n    return res.render('personal/list', templateData)\n  } catch (e) {\n    logger.error(`render_personal_list_error=>${e}`)\n    return res.render('common/error')\n  }\n})\n\n// 消费记录\nrouter.get('/balance', (req, res, next) => {\n  let param = {\n    req: req,\n    matchJavascript: true,\n    matchStylesheet: true\n  }\n\n  let templateData = routerUtil.getTemplateBasicData(param)\n\n  Object.assign(templateData, { 'title': '帐户明细' })\n\n  return res.render('personal/balance', templateData)\n})\n\n// 个人信息\nrouter.get('/info', (req, res, next) => {\n  let param = {\n    req: req,\n    matchJavascript: true,\n    matchStylesheet: true\n  }\n\n  let templateData = routerUtil.getTemplateBasicData(param)\n\n  Object.assign(templateData, { 'title': '个人信息' },{\n    \"name\":req.session.user.name,\n    \"idCardNo\":req.session.user.idCardNo,\n    \"phoneNo\":req.session.user.phoneNo,\n    \"level\":req.session.user.member.memberLevel.name\n  })\n\n  return res.render('personal/info', templateData)\n})\n\n\n// 积分记录\nrouter.get('/credits', (req, res, next) => {\n  let param = {\n    req: req,\n    matchJavascript: true,\n    matchStylesheet: true\n  }\n\n  let templateData = routerUtil.getTemplateBasicData(param)\n\n  Object.assign(templateData, { 'title': '积分明细' })\n\n  return res.render('personal/credits', templateData)\n})\n\n//我的优惠券\nrouter.get('/coupon', (req, res, next) => {\n  let param = {\n    req: req,\n    matchJavascript: true,\n    matchStylesheet: true\n  }\n\n  let templateData = routerUtil.getTemplateBasicData(param)\n\n  Object.assign(templateData, { 'title': '我的优惠券' })\n\n  return res.render('personal/coupon', templateData)\n})\n\n/**\n * @desc 豪气排名\n */\nrouter.get('/sprit', async (req, res, next) => {\n  try {\n    let param = {\n      req: req,\n      matchJavascript: false,\n      matchStylesheet: false\n    }\n\n    let templateData = routerUtil.getTemplateBasicData(param);\n\n    let monthRanking = await requestHelper.get({\n      'moduleName': 'hulk_service',\n      'controller': 'sprit',\n      'action': 'find',\n      'data': {\n        startDatetime: moment().startOf('month').format('YYYY-MM-DD hh:mm:ss'),\n        endDatetime: moment().endOf('month').format('YYYY-MM-DD hh:mm:ss')\n      }\n    })\n    let monthTotal = await requestHelper.get({\n      'moduleName': 'hulk_service',\n      'controller': 'sprit',\n      'action': 'totalByMemberId',\n      'data': {\n          startDatetime: moment().startOf('month').format('YYYY-MM-DD hh:mm:ss'),\n          endDatetime: moment().endOf('month').format('YYYY-MM-DD hh:mm:ss'),\n          memberId: req.session.user.member.id\n        }\n    })\n\n    let yearRanking =  await requestHelper.get({\n      'moduleName': 'hulk_service',\n      'controller': 'sprit',\n      'action': 'find',\n      'data': {\n        startDatetime: moment().startOf('year').format('YYYY-MM-DD hh:mm:ss'),\n        endDatetime: moment().endOf('year').format('YYYY-MM-DD hh:mm:ss')\n      }\n    })\n\n    let yearTotal = await requestHelper.get({\n      'moduleName': 'hulk_service',\n      'controller': 'sprit',\n      'action': 'totalByMemberId',\n      'data': {\n          startDatetime: moment().startOf('year').format('YYYY-MM-DD hh:mm:ss'),\n          endDatetime: moment().endOf('year').format('YYYY-MM-DD hh:mm:ss'),\n          memberId: req.session.user.member.id\n        }\n    })\n    let info = {\n      monthTotal:monthTotal.data,\n      yearTotal:yearTotal.data,\n      monthRanking:monthRanking.data.rows,\n      yearRanking:yearRanking.data.rows\n    }\n    Object.assign(templateData, { 'title': '豪气排名' },info)\n\n    return res.render('personal/sprit', templateData)\n  } catch (e) {\n    logger.error(`render_ranking_error=>${JSON.stringify(e)}`)\n    return res.render('common/error')\n  }\n})\n\nmodule.exports = router\n"]}